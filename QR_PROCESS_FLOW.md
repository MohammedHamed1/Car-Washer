# ğŸ”„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ÙƒØ§Ù…Ù„Ø© Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙˆØ§Ù„Ù€ QR ÙÙŠ PayPass

## ğŸ“‹ Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…      â”‚    â”‚   Ø§Ù„Ù†Ø¸Ø§Ù…        â”‚    â”‚   Ù…Ø­Ø·Ø© Ø§Ù„ØºØ³ÙŠÙ„   â”‚
â”‚   (Frontend)    â”‚    â”‚   (Backend)     â”‚    â”‚   (Scanner)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¯ Ø§Ù„Ù…Ø±Ø§Ø­Ù„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©

### **Ø§Ù„Ù…Ø±Ø­Ù„Ø© 1: Ø´Ø±Ø§Ø¡ Ø§Ù„Ø¨Ø§Ù‚Ø© ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   1. Ø´Ø±Ø§Ø¡ Ø§Ù„Ø¨Ø§Ù‚Ø©                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… â† ÙŠØ®ØªØ§Ø± Ø¨Ø§Ù‚Ø© â† ÙŠØ¯ÙØ¹ â† Ø§Ù„Ù†Ø¸Ø§Ù… â† ÙŠÙ†Ø´Ø¦ Ø­Ø²Ù…Ø© Ù…Ø³ØªØ®Ø¯Ù…      â”‚
â”‚                                                                â”‚
â”‚ ğŸ“± Frontend:                                                   â”‚
â”‚ - Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¨Ø§Ù‚Ø© (Ø£Ø³Ø§Ø³ÙŠØ©/Ù…ØªÙ‚Ø¯Ù…Ø©/Ø´Ø§Ù…Ù„Ø©/VIP)                    â”‚
â”‚ - Ø§Ø®ØªÙŠØ§Ø± Ø­Ø¬Ù… Ø§Ù„Ø³ÙŠØ§Ø±Ø© (ØµØºÙŠØ±Ø©/Ù…ØªÙˆØ³Ø·Ø©/ÙƒØ¨ÙŠØ±Ø©)                    â”‚
â”‚ - Ø§Ù„Ø¯ÙØ¹ Ø¹Ø¨Ø± HyperPay                                           â”‚
â”‚                                                                â”‚
â”‚ ğŸ”§ Backend:                                                    â”‚
â”‚ - Ø¥Ù†Ø´Ø§Ø¡ UserPackage                                            â”‚
â”‚ - Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙØ±ÙŠØ¯: PAYPASS-{userId}-{packageId}-{timestamp} â”‚
â”‚ - Ø¥Ù†Ø´Ø§Ø¡ QR Code                                                â”‚
â”‚                                                                â”‚
â”‚ ğŸ“„ Ø§Ù„Ù†ØªÙŠØ¬Ø©:                                                    â”‚
â”‚ - Ø­Ø²Ù…Ø© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯Ø©                                            â”‚
â”‚ - Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙØ±ÙŠØ¯                                                  â”‚
â”‚ - QR Code Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **Ø§Ù„Ù…Ø±Ø­Ù„Ø© 2: Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   2. Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ“± Frontend:                                                   â”‚
â”‚ - Ø¹Ø±Ø¶ QR Code ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚                                       â”‚
â”‚ - Ø¥Ù…ÙƒØ§Ù†ÙŠØ© ØªØ­Ù…ÙŠÙ„ QR Code                                        â”‚
â”‚ - Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø·Ø¨Ø§Ø¹Ø© QR Code                                        â”‚
â”‚                                                                â”‚
â”‚ ğŸ¨ QR Code ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰:                                          â”‚
â”‚ {                                                              â”‚
â”‚   "type": "user_package",                                      â”‚
â”‚   "barcode": "PAYPASS-123-456-789",                           â”‚
â”‚   "userId": "user123",                                         â”‚
â”‚   "packageId": "package456",                                   â”‚
â”‚   "washesLeft": 5,                                             â”‚
â”‚   "expiry": "2024-12-31",                                      â”‚
â”‚   "status": "active"                                           â”‚
â”‚ }                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **Ø§Ù„Ù…Ø±Ø­Ù„Ø© 3: Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙÙŠ Ù…Ø­Ø·Ø© Ø§Ù„ØºØ³ÙŠÙ„**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   3. Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ“± Ù…Ø­Ø·Ø© Ø§Ù„ØºØ³ÙŠÙ„:                                                â”‚
â”‚ - Ù…Ø³Ø­ QR Code Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§                                         â”‚
â”‚ - Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø®Ø§Ø¯Ù…                                        â”‚
â”‚                                                                â”‚
â”‚ ğŸ”§ Backend:                                                    â”‚
â”‚ POST /api/washes/scan-barcode                                  â”‚
â”‚ {                                                              â”‚
â”‚   "barcode": "PAYPASS-123-456-789",                           â”‚
â”‚   "washingPlace": "place123"                                   â”‚
â”‚ }                                                              â”‚
â”‚                                                                â”‚
â”‚ âœ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù†:                                                   â”‚
â”‚ - ØµØ­Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯                                                 â”‚
â”‚ - ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø­Ø²Ù…Ø©                                                â”‚
â”‚ - ÙˆØ¬ÙˆØ¯ ØºØ³Ù„Ø§Øª Ù…ØªØ¨Ù‚ÙŠØ©                                            â”‚
â”‚ - Ø¹Ø¯Ù… Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **Ø§Ù„Ù…Ø±Ø­Ù„Ø© 4: Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØºØ³ÙŠÙ„**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   4. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØºØ³ÙŠÙ„                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ”§ Backend Processing:                                         â”‚
â”‚                                                                â”‚
â”‚ 1ï¸âƒ£ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø­Ø²Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:                                    â”‚
â”‚    UserPackage.findOne({ barcode, status: 'active' })         â”‚
â”‚                                                                â”‚
â”‚ 2ï¸âƒ£ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©:                                        â”‚
â”‚    - expiry > new Date()                                       â”‚
â”‚    - washesLeft > 0                                            â”‚
â”‚                                                                â”‚
â”‚ 3ï¸âƒ£ Ø®ØµÙ… ØºØ³Ù„Ø© ÙˆØ§Ø­Ø¯Ø©:                                             â”‚
â”‚    userPackage.washesLeft -= 1                                 â”‚
â”‚    if (washesLeft === 0) status = 'used'                      â”‚
â”‚                                                                â”‚
â”‚ 4ï¸âƒ£ Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ Ø§Ù„ØºØ³ÙŠÙ„:                                          â”‚
â”‚    new Wash({                                                  â”‚
â”‚      user: userPackage.user._id,                              â”‚
â”‚      washingPlace,                                             â”‚
â”‚      package: userPackage.package._id,                        â”‚
â”‚      status: 'completed',                                      â”‚
â”‚      owner: req.user._id                                       â”‚
â”‚    })                                                          â”‚
â”‚                                                                â”‚
â”‚ 5ï¸âƒ£ Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…:                                       â”‚
â”‚    sendNotification({                                          â”‚
â”‚      type: 'feedback',                                         â”‚
â”‚      message: 'ÙŠØ±Ø¬Ù‰ ØªÙ‚ÙŠÙŠÙ… Ø§Ù„ØºØ³ÙŠÙ„ Ø§Ù„Ø£Ø®ÙŠØ±'                       â”‚
â”‚    })                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **Ø§Ù„Ù…Ø±Ø­Ù„Ø© 5: Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù„Ù„Ù…Ø­Ø·Ø©**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   5. Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù„Ù„Ù…Ø­Ø·Ø©                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ“± Ù…Ø­Ø·Ø© Ø§Ù„ØºØ³ÙŠÙ„ ØªØ³ØªÙ‚Ø¨Ù„:                                         â”‚
â”‚ {                                                              â”‚
â”‚   "success": true,                                             â”‚
â”‚   "user": {                                                    â”‚
â”‚     "name": "Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯",                                       â”‚
â”‚     "phone": "+966501234567"                                   â”‚
â”‚   },                                                           â”‚
â”‚   "carSize": "medium",                                         â”‚
â”‚   "package": {                                                 â”‚
â”‚     "name": "Ø§Ù„Ø¨Ø§Ù‚Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©",                                 â”‚
â”‚     "features": ["ØºØ³ÙŠÙ„ Ø´Ø§Ù…Ù„", "ØªÙ„Ù…ÙŠØ¹"]                        â”‚
â”‚   },                                                           â”‚
â”‚   "washesLeft": 4,                                             â”‚
â”‚   "expiry": "2024-12-31",                                      â”‚
â”‚   "wash": {                                                    â”‚
â”‚     "_id": "wash123",                                          â”‚
â”‚     "status": "completed",                                     â”‚
â”‚     "createdAt": "2024-01-15T10:30:00Z"                       â”‚
â”‚   }                                                            â”‚
â”‚ }                                                              â”‚
â”‚                                                                â”‚
â”‚ âœ… Ø§Ù„Ù…Ø­Ø·Ø© ØªØ¹Ø±Ø¶:                                                â”‚
â”‚ - Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…                                             â”‚
â”‚ - Ù†ÙˆØ¹ Ø§Ù„Ø¨Ø§Ù‚Ø©                                                   â”‚
â”‚ - Ø§Ù„ØºØ³Ù„Ø§Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©                                             â”‚
â”‚ - ØªØ£ÙƒÙŠØ¯ Ù†Ø¬Ø§Ø­ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ Ø³ÙŠØ± Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªÙØµÙŠÙ„ÙŠ

### **1. Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ (Backend)**

```javascript
// ÙÙŠ userPackage.controller.js
const { generateUniqueBarcode, generateUserPackageQR } = require('../../services/barcode');

exports.createUserPackage = async (req, res) => {
  try {
    // 1. Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙØ±ÙŠØ¯
    const barcode = generateUniqueBarcode(userId, packageId);
    
    // 2. Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø²Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    const userPackage = new UserPackage({
      user: userId,
      package: packageId,
      barcode: barcode,
      washesLeft: package.washes,
      expiry: expiryDate,
      status: 'active'
    });
    
    await userPackage.save();
    
    // 3. Ø¥Ù†Ø´Ø§Ø¡ QR Code
    const qrCode = await generateUserPackageQR(userPackage);
    
    res.json({
      success: true,
      userPackage,
      qrCode: qrCode
    });
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
};
```

### **2. Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ (Backend)**

```javascript
// ÙÙŠ wash.controller.js
const { validateBarcode, extractBarcodeInfo } = require('../../services/barcode');

exports.scanBarcodeAndDeductWash = async (req, res) => {
  try {
    const { barcode, washingPlace } = req.body;
    
    // 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
    if (!validateBarcode(barcode)) {
      return res.status(400).json({ error: 'Ø¨Ø§Ø±ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­' });
    }
    
    // 2. Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
    const barcodeInfo = extractBarcodeInfo(barcode);
    
    // 3. Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø­Ø²Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    const userPackage = await UserPackage.findOne({
      barcode: barcode,
      status: 'active',
      expiry: { $gt: new Date() },
      washesLeft: { $gt: 0 }
    }).populate('user package');
    
    if (!userPackage) {
      return res.status(400).json({ 
        error: 'Ø¨Ø§Ø±ÙƒÙˆØ¯ ØºÙŠØ± ØµØ§Ù„Ø­ Ø£Ùˆ Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ø£Ùˆ Ù„Ø§ ØªÙˆØ¬Ø¯ ØºØ³Ù„Ø§Øª Ù…ØªØ¨Ù‚ÙŠØ©' 
      });
    }
    
    // 4. Ø®ØµÙ… ØºØ³Ù„Ø© ÙˆØ§Ø­Ø¯Ø©
    userPackage.washesLeft -= 1;
    if (userPackage.washesLeft === 0) {
      userPackage.status = 'used';
    }
    await userPackage.save();
    
    // 5. Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ Ø§Ù„ØºØ³ÙŠÙ„
    const wash = new Wash({
      user: userPackage.user._id,
      washingPlace: washingPlace,
      package: userPackage.package._id,
      status: 'completed',
      owner: req.user._id
    });
    await wash.save();
    
    // 6. Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
    await sendNotification({
      user: userPackage.user._id,
      type: 'feedback',
      message: 'ÙŠØ±Ø¬Ù‰ ØªÙ‚ÙŠÙŠÙ… Ø§Ù„ØºØ³ÙŠÙ„ Ø§Ù„Ø£Ø®ÙŠØ± ÙˆØ¥Ø¶Ø§ÙØ© Ø¥ÙƒØ±Ø§Ù…ÙŠØ© Ø§Ø®ØªÙŠØ§Ø±ÙŠØ©',
      relatedWash: wash._id
    });
    
    // 7. Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù†ØªÙŠØ¬Ø©
    res.json({
      success: true,
      user: userPackage.user,
      carSize: userPackage.carSize,
      package: userPackage.package,
      washesLeft: userPackage.washesLeft,
      expiry: userPackage.expiry,
      wash: wash
    });
    
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
};
```

### **3. Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ (Frontend)**

```javascript
// ÙÙŠ qrCode.js (Frontend)
async generatePackageQR(packageData) {
  try {
    const qrData = {
      type: 'user_package',
      packageId: packageData.id,
      userId: packageData.userId,
      packageType: packageData.packageType,
      washesLeft: packageData.washesLeft,
      expiresAt: packageData.expiresAt,
      createdAt: packageData.createdAt
    };

    const qrString = JSON.stringify(qrData);
    const qrImage = await this.generateQR(qrString);
    
    return {
      success: true,
      data: {
        qrImage,
        qrData,
        qrString
      }
    };
  } catch (error) {
    throw new Error('ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø±Ù…Ø² QR');
  }
}
```

## ğŸ¯ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„Ù…Ø®ØªÙ„ÙØ©

### **1. Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø­Ø²Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…**
```
PAYPASS-{userId}-{packageId}-{timestamp}-{randomString}
Ù…Ø«Ø§Ù„: PAYPASS-user123-package456-1703123456789-abc123def456
```

### **2. Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø­Ø·Ø© Ø§Ù„ØºØ³ÙŠÙ„**
```json
{
  "type": "washing_place",
  "placeId": "place123",
  "name": "Ù…Ø­Ø·Ø© Ø§Ù„ØºØ³ÙŠÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©",
  "location": { "lat": 24.7136, "lng": 46.6753 },
  "phone": "+966501234567"
}
```

### **3. Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„Ø¯ÙØ¹**
```json
{
  "type": "payment",
  "paymentId": "payment123",
  "amount": 150,
  "currency": "SAR",
  "status": "pending",
  "timestamp": "2024-01-15T10:30:00Z"
}
```

## âš ï¸ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡

### **Ø£Ø®Ø·Ø§Ø¡ Ø´Ø§Ø¦Ø¹Ø©:**
1. **Ø¨Ø§Ø±ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­** - Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙ†Ø³ÙŠÙ‚
2. **Ø­Ø²Ù…Ø© Ù…Ù†ØªÙ‡ÙŠØ© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©** - Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ§Ø±ÙŠØ®
3. **Ù„Ø§ ØªÙˆØ¬Ø¯ ØºØ³Ù„Ø§Øª Ù…ØªØ¨Ù‚ÙŠØ©** - Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¹Ø¯Ø¯
4. **Ø­Ø²Ù…Ø© ØºÙŠØ± Ù†Ø´Ø·Ø©** - Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø§Ù„Ø©

### **Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø®Ø·Ø£:**
```javascript
// Ø¨Ø§Ø±ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­
{ "error": "Ø¨Ø§Ø±ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­" }

// Ø­Ø²Ù…Ø© Ù…Ù†ØªÙ‡ÙŠØ© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©
{ "error": "Ø§Ù„Ø­Ø²Ù…Ø© Ù…Ù†ØªÙ‡ÙŠØ© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©" }

// Ù„Ø§ ØªÙˆØ¬Ø¯ ØºØ³Ù„Ø§Øª Ù…ØªØ¨Ù‚ÙŠØ©
{ "error": "Ù„Ø§ ØªÙˆØ¬Ø¯ ØºØ³Ù„Ø§Øª Ù…ØªØ¨Ù‚ÙŠØ© ÙÙŠ Ø§Ù„Ø­Ø²Ù…Ø©" }

// Ø­Ø²Ù…Ø© ØºÙŠØ± Ù†Ø´Ø·Ø©
{ "error": "Ø§Ù„Ø­Ø²Ù…Ø© ØºÙŠØ± Ù†Ø´Ø·Ø©" }
```

## ğŸ”’ Ø§Ù„Ø£Ù…Ø§Ù†

### **Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø£Ù…Ø§Ù†:**
1. **ØªØ´ÙÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª** ÙÙŠ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
2. **Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©** ÙÙŠ ÙƒÙ„ Ø¹Ù…Ù„ÙŠØ©
3. **ØªØªØ¨Ø¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª** Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ÙƒØ±Ø±
4. **Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…** ÙÙŠ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø­Ø³Ø§Ø³Ø©

### **Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ù…Ø§Ù†:**
```javascript
// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø±ØªÙŠÙ†
const existingWash = await Wash.findOne({
  userPackage: userPackage._id,
  createdAt: { $gte: new Date(Date.now() - 5 * 60 * 1000) } // Ø¢Ø®Ø± 5 Ø¯Ù‚Ø§Ø¦Ù‚
});

if (existingWash) {
  return res.status(400).json({ error: 'ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¤Ø®Ø±Ø§Ù‹' });
}
```

## ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©

### **Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡:**
- **ÙˆÙ‚Øª Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©:** < 2 Ø«Ø§Ù†ÙŠØ©
- **Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù†Ø¬Ø§Ø­:** > 99%
- **Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡:** < 1%
- **Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙŠÙˆÙ…ÙŠ:** Ø­Ø³Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø·Ø§Øª

### **Ø§Ù„ØªØªØ¨Ø¹:**
- **Ø¹Ø¯Ø¯ Ø§Ù„ØºØ³Ù„Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©**
- **Ø£ÙƒØ«Ø± Ø§Ù„Ø¨Ø§Ù‚Ø§Øª Ø§Ø³ØªØ®Ø¯Ø§Ù…Ø§Ù‹**
- **Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ø°Ø±ÙˆØ©**
- **Ù…Ø¹Ø¯Ù„ Ø±Ø¶Ø§ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡**

Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ØªØ¶Ù…Ù† ØªØ¬Ø±Ø¨Ø© Ø³Ù„Ø³Ø© ÙˆØ¢Ù…Ù†Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ø¹ ØªØªØ¨Ø¹ Ø¯Ù‚ÙŠÙ‚ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª! ğŸ‰ 